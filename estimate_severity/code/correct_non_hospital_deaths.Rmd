---
title: "Correcting for deaths outside of hospital and ICU"
author: Daniel Herrera
output: pdf_document
header-includes:
  - \usepackage{setspace}\doublespacing
  - \usepackage{float}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

## Objective

To estimate the age-stratified proportion of severe and critical
cases among individuals infected with SARS-CoV-2 (ISR and ICR respectively),
we identified countries with age-stratified seroprevalence
studies that also report the age-stratified number of patients that
were hospitalized (indicator of severe disease) or admitted
to the ICU (indicator of critical disease). This allows us to
estimate the ISR and ICR directly, by dividing the number of
hospitalizations and ICU admissions by the estimated number of
infected individuals.
\newline

However, one factor that may affect this procedure is that
hospitalizations and ICU admissions may not fully reflect
severe and critical cases. In particular, it is frequent for
deaths in older patients to occur outside of the hospital or
the ICU, thus constituting severe and critical cases that are
not reported in the hospitalization numbers. To minimize
the effect of this phenomenon in our estimations, we
analyze to what extent COVID-19 deaths are not reported
in hospitalization and ICU numbers across locations and
ages, so as to correct for this phenomenon in our analysis.

## Analysis of raw data

```{r include=FALSE}
source("value_adjusting.R")
library(knitr)
#
```


### Data points with more deaths than ICU admissions

```{r include=FALSE}
moreDeaths <- countryData %>%
  dplyr::mutate(., moreDeathsHosp=Deaths>Hospitalized,
                moreDeathsICU=Deaths>ICU) %>%
  dplyr::filter(., (moreDeathsHosp | moreDeathsICU) |
  (is.na(moreDeathsHosp) & moreDeathsICU) |
  (is.na(moreDeathsICU) & moreDeathsHosp))
nLocs <- length(unique(countryData$Location))
```

Our dataset of countries with serology studies and
hospitalization or ICU data contains `r nLocs` locations:
`r unique(countryData$Location)`.
\newline

First we look for the most salient indicator of deaths outside of 
the hospital or the ICU: populations were the number of reported deaths
is higher than the number of reported hospitalizations or ICU admissions.
We find that `r nrow(moreDeaths)` locations and ages that show
this property (**Table 1**). Some of these points show a death
count one order of magnitude larger than hospitalizations and
ICU admissions (or two orders of magnitude in the case of England),
underscoring the need to correct for deaths not
included in hospital and ICU counts.

```{r echo=FALSE}
moreDeaths <- dplyr::select(moreDeaths, Age, Location, Hospitalized, ICU, Deaths)
knitr::kable(moreDeaths, caption="Data points with more deaths than Hospitalizations or ICU")
```

```{r echo=FALSE}
#
hospMaxRatio <- countryLong %>%
  dplyr::mutate(., ratio=Deaths/Outcome_count) %>%
#  dplyr::filter(., str_detect(Age, "\\+") & !is.na(ratio) & (ratio<=1) &
#                Outcome_type=="Hospitalized") %>% 
  dplyr::filter(., (Age %in% c("80+", "85+")) & !is.na(ratio) & (ratio<=1) &
                Outcome_type=="Hospitalized") %>% 
  summarize(., meanRatio=mean(ratio), meanAge=mean(meanAge))
fittedHosp <- dplyr::filter(lethalityPosterior, (meanAge==85) &
                            (Outcome_type=="Hospitalized"))[["prop_mean"]]
icuRatio <- countryLong %>%
  dplyr::mutate(., ratio=Deaths/Outcome_count) %>%
  dplyr::filter(., (meanAge<60) & (meanAge>=50) & !is.na(ratio) & (ratio<=1) &
                Outcome_type=="ICU") %>% 
  summarize(., meanRatio=mean(ratio), meanAge=mean(meanAge))
fittedICU <- dplyr::filter(lethalityPosterior, meanAge==60 &
                             Outcome_type=="ICU")[["prop_mean"]]
ratioOfRatiosHosp <- round(fittedHosp/hospMaxRatio$meanRatio, digits=2)
ratioOfRatiosICU <- round(fittedICU/icuRatio$meanRatio, digits=2)
```

### Ratio of deaths to hospitalizations in public data and in hospital mortality studies

Next, we compared the ratio between deaths and hospitalization (or ICU)
counts reported by the countries, to the reported in-hospital (or ICU)
lethality in the literature. Since the ratio with public data takes into
account all deaths, and the ratio of in-hospital studies take into
account only hospital deaths, a deviation between the two may
reflect the presence of deaths outside the hospital.
\newline

```{r echo=FALSE, warning=FALSE, fig1, fig.height=4.5, fig.width=9, fig.cap="Ratio of deaths to hospitalizations (left) and ICU admissions (right). Dots show the ratio for public data for different locations. The black line and shaded region show the fitted ratio for in-hospital and in-ICU lethality"}
public_vs_expected_ratio
```

As can be seen in **Figure 1 (left)**, for most ages the ratio of
deaths to hospitalizations is close to the in-hospital lethality
fitted to several literature reports (black line and
shaded region). Nonetheless, at the oldest ages, all the locations are
above the fitted line, suggesting that for the oldest ages there
are deaths outside of the hospital. For the ratio of deaths
to ICU admissions (**Figure 1, right**), we see that almost all
points across ages are above the ratio fitted to in-ICU mortality
studies, indicating a widespread occurrence of deaths outside
of the ICU.

In particular, we can look at the ratio between the ratios shown in the plot
(the in-hospital mortality and the ratio in public data) to approximate what
proportion of deaths occurs in the hospital (deaths in hospital rate, or DHR)
or ICU (deaths in ICU rate, or DIR) for each age. The formula for DHR is
shown below, and the formula for DIR is analogous:

\begin{equation}
\label{DHR}
DHR = \frac{Mortality_{Hospital}}{\left(\frac{Deaths_{Total}}{Hospitalizations}\right)} =
\frac{\left(\frac{Deaths_{Hospital}}{Hospitalizations}\right)}{\left(\frac{Deaths_{Total}}{Hospitalizations}\right)} =
\frac{Deaths_{Hospital}}{Deaths_{Total}}
\end{equation}


```{r echo=FALSE, warning=FALSE, fig2, fig.height=4.5, fig.width=9, fig.cap="Ratio of death to hospitalization (left) and ICU (right) in public data over the ratio as obtained from in-hospital or in-ICU mortality."}
ratio_of_ratios
```


## Locations with disaggregated death data

Some locations have disaggregated data of total deaths and deaths in
the hospital or ICU. We can compare these data to the ratios obtained
in the previous section.

We observe in Figure 3 the ratios of in-hospital (and in-ICU)
deaths to total deaths for different countries and ages. We see that the
different countries show a general agreement in the magnitude of the ratio
between hospital and ICU deaths to total deaths. Furthermore, these numbers
seem in general agreement with what is expected from comparing the
observed deaths to hospitalization ratio in the previous section to
the reported in-hospital (or in-ICU) mortality. For example, we reported
that for the 50-59 year range the ratio of ratios is `r ratioOfRatiosICU`,
while the ratio between ICU deaths and total deaths for the 50-59 age
range for England is 0.45. The ratio of ratios for hospitalization
deaths for 80+ was `r ratioOfRatiosHosp`, and the ratio of hospital
deaths to total deaths at 80+ is 0.51 for England, and at 80-89
is 0.34 for Netherlands.



```{r echo=FALSE, warning=FALSE, fig3, fig.height=4.5, fig.width=11, fig.cap="Ratio of hospital (left) and ICU (right) deaths to the total reported deaths for each age stratum."}
deathRatioPlot
```

```{r echo=FALSE}
#knitr::kable(hospDeathDf, caption="Comparison of deaths in hospital and total reported deaths")
```

```{r echo=FALSE}
#knitr::kable(icuDeathDf, caption="Comparison of deaths in ICU and total deaths")
```


## Correction of data of critical and severe outcomes

In order to correct for deaths outside of the hospital and ICU, thus
counting them as severe and critical cases, we estimated from the total
number of deaths for a given location and age, how many occurred inside the
hospital or the ICU, and how many occurred outside. Then, we added the
number of deaths estimated to occur outside of the hospital or the ICU
to the count of severe or critical cases, respectively. This procedure was
not applied in countries where the data allowed to discriminate
between deaths inside and outside of the hospital or ICU.

For this procedure, we first computed the DHR and DIR for each location and age
with Equation \ref{DHR}, using the individual samples of the bayesian model
fitted to hospital or ICU mortality. In this procedure, we set all
samples with a DHR>1 to DHR=1. Then, we average the sampled DHRs and
estimate the number of deaths outside the hospital (outside of hospital deaths,
or OHD) for each age (A) and location (L) as:

\begin{equation}
\label{OHD}
OHD^{L}_{A} = DHR^{L}_{A}\times Deaths^{L}_{A}
\end{equation}

We then add these estimated deaths to the severe cases. The same procedure is
applied for out of ICU deaths and critical cases. Importantly, the number of
severe or critical cases that this procedure adds to a given location and age
is bounded by the number of deaths at that location and age. For young and
middle-aged populations, the number of deaths is much smaller than the number
of hospitalizations and ICU admissions, and thus this procedure does not
change the number of severe and critical cases substantially.

In line with this, as can be seen in Figure 4, the proportion of severe
and critical outcomes remain largely unchanged by the correction procedure
for younger and middle age populations. Also, as could be expected from the
analysis seen in Figures 1 and 2, the change is very small across all ages
for severe disease. Thus, as could be expected from the analyses above,
we see that the data points most affected by the procedure are those
corresponding to critical disease outcome in older age individuals.

```{r echo=FALSE, warning=FALSE, fig4, fig.height=6, fig.width=9, fig.cap="Percentage of infections that develop severe (top) and critical (bottom) disease, with the correction for out of hospital and out of ICU deaths applied (left) or without the correction (right)"}
outcome <- c("Hospitalized", "ICU", "Deaths")
longCountryData <- tidyr::pivot_longer(data=countryData, 
                                       cols=all_of(outcome),
                                       names_to="Outcome_type",
                                       values_to="Outcomes") %>%
  dplyr::filter(., !is.na(Outcomes) & (Outcome_type!="Deaths")) %>%
  dplyr::mutate(., Location=factor(Location), Status="Not-corrected")
longCountryData$Outcome_type <- factor(longCountryData$Outcome_type,
                                       levels=outcome[-3])
longCountryData_corrected <- tidyr::pivot_longer(data=correctedDf, 
                                       cols=all_of(outcome),
                                       names_to="Outcome_type",
                                       values_to="Outcomes") %>%
  dplyr::filter(., !is.na(Outcomes) & (Outcome_type!="Deaths")) %>%
  dplyr::mutate(., Location=factor(Location), Status="Corrected")
longCountryData_corrected$Outcome_type <- factor(longCountryData_corrected$Outcome_type,
                                       levels=outcome[-3])

allData <- rbind(longCountryData, longCountryData_corrected)

serologyPlot <- allData %>%
  ggplot(., aes(x=meanAge, y=Outcomes*100/(Population*Prevalence/100), color=Location,
                linetype=Type, facet=Outcome_type)) +
  geom_point(aes(shape=Type), size=locPointSize) +
  geom_line(alpha=locLineAlpha, size=locLineSize) +
  facet_grid(Outcome_type~Status) +
  scale_y_continuous(trans='log10', labels=scaleFun) +
  theme_bw() +
  xlab("Age") +
  ylab("% outcome")
serologyPlot
```


